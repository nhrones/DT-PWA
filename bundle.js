// deno-lint-ignore-file
var E=Object.defineProperty;var c=(h,t)=>E(h,"name",{value:t,configurable:!0});var u=c((h,t,e)=>h.addEventListener(t,e),"on"),f=class extends HTMLElement{static{c(this,"PinComponent")}static register(){customElements.define("pin-component",this)}shadow;constructor(){super();let e=HTMLElement.prototype.hasOwnProperty("attachInternals")?this.attachInternals():void 0;this.shadow=e?.shadowRoot}init(t){let e=this.shadow.getElementById("popupDialog"),s=this.shadow.getElementById("pinDialog"),n=this.shadow.getElementById("pin"),a=this.shadow.getElementById("popup_text");u(e,"click",i=>{i.preventDefault(),e.close()});let o=0,r=!1;u(e,"close",i=>{i.preventDefault(),r||s.showModal()}),u(e,"keyup",i=>{i.preventDefault(),e.close(),r||s.showModal()}),s?.addEventListener("keydown",i=>{i.key==="Escape"&&i.preventDefault()}),u(n,"keyup",i=>{i.preventDefault();let y=this.encryptText(n.value);(i.key==="Enter"||y===t.PIN)&&(o+=1,y===t.PIN?(n.value="",r=!0,s.close()):(s.close(),n.value="",r=!1,a&&(a.textContent=o===3?`Incorrect pin entered ${o} times!
       Please close this Page!`:`Incorrect pin entered ${o} times!`),o===3?document.body.innerHTML=`
                     <h1>Three failed PIN attempts!</h1>
                     <h1>Please close this page!</h1>`:e.showModal()))}),s.showModal(),n.focus({focusVisible:!0}),document.addEventListener("keydown",function(i){i.ctrlKey&&i.key==="x"&&(i.preventDefault(),r=!0,s.close())})}encryptText(t){let e="",s="ndhg";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t.charCodeAt(n)^s.charCodeAt(n%s.length));return e}};f.register();var b=class extends HTMLElement{static{c(this,"FooterComponent")}static register(){customElements.define("footer-component",this)}addBtn;deleteBtn;shadow;constructor(){super();let e=HTMLElement.prototype.hasOwnProperty("attachInternals")?this.attachInternals():void 0;if(this.shadow=e?.shadowRoot,!this.shadow){this.shadow=this.attachShadow({mode:"closed"});let s=document.getElementById("footerTemplate");this.shadow.append(s.content.cloneNode(!0))}}init(t,e){let s=document.getElementById("table-component").init(t,e);this.addBtn=this.shadow.getElementById("addbtn"),this.addBtn.onclick=a=>{let o=Object.assign({},t.sampleRecord);for(let i in o)typeof o[i]=="object"&&(o[i]=o[i][0]);let r=t.keyColumnName;s.kvCache.set(o[r],o),s.buildDataTable(),s.scrollToBottom()},this.deleteBtn=this.shadow.getElementById("deletebtn"),this.deleteBtn.onclick=a=>{s.kvCache.delete(s.kvCache.CTX.FocusedKey),s.buildDataTable()};let n=this.shadow.getElementById("fileload");return document.addEventListener("keydown",function(a){if(a.ctrlKey&&a.key==="b"){a.preventDefault();let o=JSON.stringify(Array.from(s.kvCache.dbMap.entries())),r=document.createElement("a"),i=new Blob([o],{type:"application/json"});r.href=URL.createObjectURL(i),r.download="backup.json",r.click(),URL.revokeObjectURL(r.href)}a.ctrlKey&&a.key==="r"&&(a.preventDefault(),n.click(),n.addEventListener("change",function(){let o=new FileReader;o.onload=function(){s.kvCache.restoreCache(o.result)},o.readAsText(n.files[0])}))}),s}resetButtons(t){t?(this.deleteBtn.setAttribute("hidden",""),this.addBtn.removeAttribute("hidden")):(this.addBtn.setAttribute("hidden",""),this.deleteBtn.removeAttribute("hidden"))}};b.register();var p=class{static{c(this,"KvClient")}DEV=!1;nextMsgID=0;querySet=[];transactions=new Map;currentPage=1;focusedRow=null;kvCache;CTX;ServiceURL;RegistrationURL;constructor(t,e){this.CTX=e,this.DEV=e.DEV,this.ServiceURL=e.LOCAL_DB?e.LocalDbURL:e.RemoteDbURL,this.RegistrationURL=this.ServiceURL+e.RpcURL,this.kvCache=t,this.transactions=new Map}init(){let t=new EventSource(this.RegistrationURL);console.log("CONNECTING"),t.addEventListener("open",()=>{this.callProcedure(this.ServiceURL,"GET",{key:["PIN"]}).then(e=>{this.CTX.PIN=e.value,this.fetchQuerySet()})}),t.addEventListener("error",e=>{switch(t.readyState){case EventSource.OPEN:console.log("CONNECTED");break;case EventSource.CONNECTING:console.log("CONNECTING");break;case EventSource.CLOSED:console.log("DISCONNECTED");break}}),t.addEventListener("message",e=>{let s=JSON.parse(e.data),{txID:n,error:a,result:o}=s;if(n===-1&&this.handleMutation(o),!this.transactions.has(n))return;let r=this.transactions.get(n);this.transactions.delete(n),r&&r(a,o)})}handleMutation(t){console.info("Mutation event:",t)}async setKvPin(t){let e=this.kvCache.encryptText(t);await this.callProcedure(this.ServiceURL,"SET",{key:["PIN"],value:e}).then(s=>{this.DEV&&console.log(`Set PIN ${t} to: `,e)})}addNewRecord(){let t=Object.assign({},this.kvCache.schema.sampleRecord);for(let s in t)typeof t[s]=="object"&&(t[s]=t[s][0]);let e=this.kvCache.schema.keyColumnName;this.kvCache.set(t[e],t)}async fetchQuerySet(){let t=this.kvCache;await this.callProcedure(this.ServiceURL,"GET",{key:[this.kvCache.schema.dbKey]}).then(e=>{e.value?t.restoreCache(t.encryptText(e.value)):(this.addNewRecord(),this.kvCache.UiHost.buildDataTable(t))})}get(t){for(let e=0;e<this.querySet.length;e++){let s=this.querySet[e];if(s.id===t)return s}}set(t){try{this.callProcedure(this.ServiceURL,"SET",{key:[this.kvCache.schema.dbKey],value:t}).then(e=>(this.querySet=e.querySet,this.querySet))}catch(e){return{Error:e}}}delete(t){try{this.callProcedure(this.ServiceURL,"DELETE",{key:t,value:""}).then(e=>{console.info("Delete result: ",e)})}catch(e){return{Error:e}}}callProcedure(t,e,s){let n=this.nextMsgID++;return new Promise((a,o)=>{this.transactions.set(n,(r,i)=>{if(r)return o(new Error(r));a(i)}),fetch(t,{method:"POST",mode:"cors",body:JSON.stringify({txID:n,procedure:e,params:s})})})}};var m=class{static{c(this,"KvCache")}UiHost;dbKey="";schema;nextMsgID=0;querySet=[];callbacks;columns=[];kvClient;dbMap;raw=[];CTX;DEV;constructor(t,e,s){this.UiHost=s,this.dbKey=`${t.dbKey}`,this.schema=t,this.CTX=e,this.DEV=this.CTX.DEV,this.callbacks=new Map,this.dbMap=new Map,this.columns=this.buildColumnSchema(this.schema.sampleRecord),this.kvClient=new p(this,e),this.kvClient.init()}encryptText(t){let e="",s="ndhg";for(let n=0;n<t.length;n++)e+=String.fromCharCode(t.charCodeAt(n)^s.charCodeAt(n%s.length));return e}restoreCache(t){let e=JSON.parse(t);this.dbMap=new Map(e),this.persist(),this.hydrate()=="ok"&&this.UiHost.buildDataTable(this)}buildColumnSchema(t){let e=[];for(let[s,n]of Object.entries(t)){let a=!1;(typeof n=="number"&&n===-1||typeof n=="string"&&n==="READONLY")&&(a=!0),e.push({name:s,type:typeof n,defaultValue:n,readOnly:a})}return e}persist(t=!0){t&&(this.dbMap=new Map([...this.dbMap.entries()].sort()));let e=JSON.stringify(Array.from(this.dbMap.entries())),s=this.encryptText(e);this.kvClient.set(s)}hydrate(){return this.raw=[...this.dbMap.values()],this.querySet=[...this.raw],this.UiHost.buildDataTable(this),this.raw.length>2?"ok":"Not found"}resetData(){this.querySet=[...this.raw]}clean(t=null){let e=new Map;[...this.dbMap.keys()].forEach(n=>{n!==t&&e.set(n,this.dbMap.get(n))}),this.dbMap=e,this.persist(!0)}set(t,e){try{return this.dbMap.set(t,e),this.persist(!0),this.hydrate(),t}catch(s){return console.error("error setting "),"Error "+s}}get(t){try{return this.dbMap.get(t)}catch(e){return"Error "+e}}delete(t){try{let e=this.dbMap.delete(t);return e===!0&&this.persist(!0),this.hydrate(),e}catch(e){return"Error "+e}}};var l,d,g=class extends HTMLElement{static{c(this,"TableComponent")}static register(){customElements.define("table-component",this)}kvCache;footer;table;tablehead;tableBody;shadow;constructor(){super();let e=HTMLElement.prototype.hasOwnProperty("attachInternals")?this.attachInternals():void 0;if(this.shadow=e?.shadowRoot,!this.shadow){this.shadow=this.attachShadow({mode:"closed"});let s=document.getElementById("tableTemplate");this.shadow.append(s.content.cloneNode(!0))}}init(t,e){return this.kvCache=new m(t,e,this),this.table=this.shadow.getElementById("table"),this.tableBody=this.shadow.getElementById("table-body"),this.tableBody.addEventListener("click",this),this.tablehead=this.shadow.getElementById("table-head"),this.footer=document.getElementById("footer-component"),this.buildTableHead(),this}handleEvent(t){console.log(t.type),this[`handle${t.type}`](t)}handleclick(t){let e=t.target;console.info("row click",e),console.info("row click",e.dataset),d&&l&&e!==l&&(l.removeAttribute("contenteditable"),l.className="",l.oninput=null),d?.classList.remove("selected_row"),d=e.parentElement,d.classList.add("selected_row"),this.kvCache.CTX.FocusedKey=d.dataset.cache_key,this.footer.resetButtons(!1),l=e,l.setAttribute("contenteditable",""),l.className="editable ";let s=d.dataset.cache_key,n=l.dataset.column_id,a=parseInt(l.dataset.column_index)||0,o=this.kvCache.get(s);l.onblur=()=>{let r=l.textContent;if(l.tagName==="SELECT"){n=l.parentElement.dataset.column_id||"",a=parseInt(l.parentElement.dataset.column_index)||0;let i=l;r=i.options[i.selectedIndex].text}o[n]!==r&&(o[n]=r,a===0?s!==r&&(this.kvCache.delete(s),s=r,this.kvCache.set(s,o)):this.kvCache.set(s,o))}}scrollToBottom(){this.tableBody.rows[this.tableBody.rows.length-1].scrollIntoView({behavior:"smooth"})}buildTableHead(){let t='<tr class="headerRow">',e="";for(let s=0;s<this.kvCache.columns.length;s++)e+=`   <th id="header${s+1}" data-index=${s} value=1>${this.kvCache.columns[s].name}</th>`;this.tablehead.innerHTML+=t+e+"</tr>";for(let s=0;s<this.kvCache.columns.length;s++){let n=this.shadow.getElementById(`header${s+1}`);n.onclick=a=>{this.resetFocusedRow(),this.buildDataTable()}}}buildDataTable(){this.tableBody.innerHTML="",this.kvCache.querySet&&this.buildRows(),this.resetFocusedRow(),l?.focus()}buildRows(){let t=this.kvCache.querySet;if(t)for(let e=0;e<t.length;e++){let s=t[e],n=`<tr data-cache_key="${s[this.kvCache.columns[0].name]}">`;for(let a=0;a<this.kvCache.columns.length;a++){let o=this.kvCache.columns[a].name;switch(this.kvCache.columns[a].type){case"boolean":let r=s[o]==="true"?"checked":"";n+=`<td data-column_index=${a} 
                  data-column_id="${o}"><input type="checkbox" ${r}></td>`;break;case"number":n+=`<td data-column_index=${a} 
                  data-column_id="${o}">${parseFloat(s[o])}</td>`;break;case"object":n+=`<td data-column_index=${a} 
                  data-column_id="${o}">${this.buildSelect(this.kvCache.columns[a].defaultValue,s[o])}</td>`;break;default:n+=`<td data-column_index=${a} 
                  data-column_id="${o}">${s[o]}</td>`;break}}n+="</tr>",this.tableBody.innerHTML+=n}}buildSelect(t,e){let s=`<select>
   `;return t.forEach(n=>{e===n?s+=`<option value="${n}" selected>${n}</option>
         `:s+=`<option value="${n}">${n}</option>
      `}),s+="</select>",s}resetFocusedRow(){this.footer.resetButtons(!0),d=null}};g.register();var C={dbKey:"PWA",keyColumnName:"host",sampleRecord:{host:"Z",login:"",pw:"",remarks:""}};document.title=C.dbKey;var v={DEV:!1,LOCAL_DB:!1,LocalDbURL:"http://localhost:9099/",RemoteDbURL:"https://dt-kv-rpc.deno.dev/",RpcURL:"SSERPC/kvRegistration",PIN:"",FocusedKey:"",dbOptions:{schema:C}};document.title="DT-PWA";var k=document.getElementById("footer-component"),w=k.init(C,v);document.getElementById("pin-component").init(w.kvCache.CTX);export{b as FooterComponent,f as PinComponent,g as TableComponent,l as focusedCell,d as focusedRow,u as on};
