// deno-lint-ignore-file
var C=Object.defineProperty;var h=(c,t)=>C(c,"name",{value:t,configurable:!0});var p=h((c,t,e)=>c.addEventListener(t,e),"on"),b=class extends HTMLElement{static{h(this,"PinComponent")}static register(){customElements.define("pin-component",this)}shadow;constructor(){super();let e=HTMLElement.prototype.hasOwnProperty("attachInternals")?this.attachInternals():void 0;this.shadow=e?.shadowRoot}init(t){let e=this.shadow.getElementById("popupDialog"),n=this.shadow.getElementById("pinDialog"),s=this.shadow.getElementById("pin"),a=this.shadow.getElementById("popup_text");p(e,"click",i=>{i.preventDefault(),e.close()});let o=0,r=!1;p(e,"close",i=>{i.preventDefault(),r||n.showModal()}),p(e,"keyup",i=>{i.preventDefault(),e.close(),r||n.showModal()}),n?.addEventListener("keydown",i=>{i.key==="Escape"&&i.preventDefault()}),p(s,"keyup",i=>{i.preventDefault();let f=this.encryptText(s.value);(i.key==="Enter"||f===t.PIN)&&(o+=1,f===t.PIN?(s.value="",r=!0,n.close()):(n.close(),s.value="",r=!1,a&&(a.textContent=o===3?`Incorrect pin entered ${o} times!
       Please close this Page!`:`Incorrect pin entered ${o} times!`),o===3?document.body.innerHTML=`
                     <h1>Three failed PIN attempts!</h1>
                     <h1>Please close this page!</h1>`:e.showModal()))}),n.showModal(),s.focus({focusVisible:!0}),document.addEventListener("keydown",function(i){i.ctrlKey&&i.key==="x"&&(i.preventDefault(),r=!0,n.close())})}encryptText(t){let e="",n="ndhg";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t.charCodeAt(s)^n.charCodeAt(s%n.length));return e}};b.register();var E=class extends HTMLElement{static{h(this,"FooterComponent")}static register(){customElements.define("footer-component",this)}addBtn;deleteBtn;shadow;constructor(){super();let e=HTMLElement.prototype.hasOwnProperty("attachInternals")?this.attachInternals():void 0;if(this.shadow=e?.shadowRoot,!this.shadow){this.shadow=this.attachShadow({mode:"closed"});let n=document.getElementById("footerTemplate");this.shadow.append(n.content.cloneNode(!0))}}init(t,e){let n=document.getElementById("table-component").init(t,e);this.addBtn=this.shadow.getElementById("addbtn"),this.addBtn.onclick=a=>{let o=Object.assign({},t.sampleRecord);for(let i in o)typeof o[i]=="object"&&(o[i]=o[i][0]);let r=t.keyColumnName;n.kvCache.set(o[r],o),n.buildDataTable(),n.scrollToBottom()},this.deleteBtn=this.shadow.getElementById("deletebtn"),this.deleteBtn.onclick=a=>{n.kvCache.delete(n.kvCache.CTX.FocusedKey),n.buildDataTable()};let s=this.shadow.getElementById("fileload");return document.addEventListener("keydown",function(a){if(a.ctrlKey&&a.key==="b"){a.preventDefault();let o=JSON.stringify(Array.from(n.kvCache.dbMap.entries())),r=document.createElement("a"),i=new Blob([o],{type:"application/json"});r.href=URL.createObjectURL(i),r.download="backup.json",r.click(),URL.revokeObjectURL(r.href)}a.ctrlKey&&a.key==="r"&&(a.preventDefault(),s.click(),s.addEventListener("change",function(){let o=new FileReader;o.onload=function(){n.kvCache.restoreCache(o.result)},o.readAsText(s.files[0])}))}),n}resetButtons(t){t?(this.deleteBtn.setAttribute("hidden",""),this.addBtn.removeAttribute("hidden")):(this.addBtn.setAttribute("hidden",""),this.deleteBtn.removeAttribute("hidden"))}};E.register();function T(){let c=new Map;return{on(e,n,s){let a=e+"-"+n;c.has(a)?c.get(a).push(s):c.set(a,[s])},fire(e,n,s){let a=e+"-"+n,o=c.get(a);if(o)for(let r of o)r(s)}}}h(T,"newEventBus");var d=T();var m=class{static{h(this,"KvClient")}DEV=!1;nextMsgID=0;querySet=[];transactions=new Map;currentPage=1;focusedRow=null;kvCache;CTX;ServiceURL;RegistrationURL;constructor(t,e){this.CTX=e,this.DEV=e.DEV,this.ServiceURL=e.LOCAL_DB?e.LocalDbURL:e.RemoteDbURL,this.RegistrationURL=this.ServiceURL+e.RpcURL,this.kvCache=t,this.transactions=new Map}init(){let t=new EventSource(this.RegistrationURL);console.log("CONNECTING"),t.addEventListener("open",()=>{this.callProcedure(this.ServiceURL,"GET",{key:["PIN"]}).then(e=>{this.CTX.PIN=e.value,this.fetchQuerySet()})}),t.addEventListener("error",e=>{switch(t.readyState){case EventSource.OPEN:console.log("CONNECTED");break;case EventSource.CONNECTING:console.log("CONNECTING");break;case EventSource.CLOSED:console.log("DISCONNECTED");break}}),t.addEventListener("message",e=>{let n=JSON.parse(e.data),{txID:s,error:a,result:o}=n;if(s===-1&&this.handleMutation(o),!this.transactions.has(s))return;let r=this.transactions.get(s);this.transactions.delete(s),r&&r(a,o)})}handleMutation(t){console.info("Mutation event:",t)}async setKvPin(t){let e=this.kvCache.encryptText(t);await this.callProcedure(this.ServiceURL,"SET",{key:["PIN"],value:e}).then(n=>{this.DEV&&console.log(`Set PIN ${t} to: `,e)})}addNewRecord(){let t=Object.assign({},this.kvCache.schema.sampleRecord);for(let n in t)typeof t[n]=="object"&&(t[n]=t[n][0]);let e=this.kvCache.schema.keyColumnName;this.kvCache.set(t[e],t)}async fetchQuerySet(){let t=this.kvCache;await this.callProcedure(this.ServiceURL,"GET",{key:[this.kvCache.schema.dbKey]}).then(e=>{e.value?t.restoreCache(t.encryptText(e.value)):(this.addNewRecord(),d.fire("buildDataTableEV","",this.kvCache))})}get(t){for(let e=0;e<this.querySet.length;e++){let n=this.querySet[e];if(n.id===t)return n}}set(t){try{this.callProcedure(this.ServiceURL,"SET",{key:[this.kvCache.schema.dbKey],value:t}).then(e=>(this.querySet=e.querySet,this.querySet))}catch(e){return{Error:e}}}delete(t){try{this.callProcedure(this.ServiceURL,"DELETE",{key:t,value:""}).then(e=>{console.info("Delete result: ",e)})}catch(e){return{Error:e}}}callProcedure(t,e,n){let s=this.nextMsgID++;return new Promise((a,o)=>{this.transactions.set(s,(r,i)=>{if(r)return o(new Error(r));a(i)}),fetch(t,{method:"POST",mode:"cors",body:JSON.stringify({txID:s,procedure:e,params:n})})})}};var y=class{static{h(this,"KvCache")}dbKey="";schema;nextMsgID=0;querySet=[];callbacks;columns=[];kvClient;dbMap;raw=[];CTX;DEV;constructor(t,e){this.dbKey=`${t.dbKey}`,this.schema=t,this.CTX=e,this.DEV=this.CTX.DEV,this.callbacks=new Map,this.dbMap=new Map,this.columns=this.buildColumnSchema(this.schema.sampleRecord),this.kvClient=new m(this,e),this.kvClient.init()}encryptText(t){let e="",n="ndhg";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t.charCodeAt(s)^n.charCodeAt(s%n.length));return e}restoreCache(t){let e=JSON.parse(t);this.dbMap=new Map(e),this.persist(),this.hydrate()=="ok"&&d.fire("buildDataTableEV","",this)}buildColumnSchema(t){let e=[];for(let[n,s]of Object.entries(t)){let a=!1;(typeof s=="number"&&s===-1||typeof s=="string"&&s==="READONLY")&&(a=!0),e.push({name:n,type:typeof s,defaultValue:s,readOnly:a})}return e}persist(t=!0){t&&(this.dbMap=new Map([...this.dbMap.entries()].sort()));let e=JSON.stringify(Array.from(this.dbMap.entries())),n=this.encryptText(e);this.kvClient.set(n)}hydrate(){return this.raw=[...this.dbMap.values()],this.querySet=[...this.raw],d.fire("buildDataTableEV","",this),this.raw.length>2?"ok":"Not found"}resetData(){this.querySet=[...this.raw]}clean(t=null){let e=new Map;[...this.dbMap.keys()].forEach(s=>{s!==t&&e.set(s,this.dbMap.get(s))}),this.dbMap=e,this.persist(!0)}set(t,e){try{return this.dbMap.set(t,e),this.persist(!0),this.hydrate(),t}catch(n){return console.error("error setting "),"Error "+n}}get(t){try{return this.dbMap.get(t)}catch(e){return"Error "+e}}delete(t){try{let e=this.dbMap.delete(t);return e===!0&&this.persist(!0),this.hydrate(),e}catch(e){return"Error "+e}}};var l,u,g=class extends HTMLElement{static{h(this,"TableComponent")}static register(){customElements.define("table-component",this)}kvCache;footer;table;tablehead;tableBody;shadow;constructor(){super();let e=HTMLElement.prototype.hasOwnProperty("attachInternals")?this.attachInternals():void 0;if(this.shadow=e?.shadowRoot,!this.shadow){this.shadow=this.attachShadow({mode:"closed"});let n=document.getElementById("tableTemplate");this.shadow.append(n.content.cloneNode(!0))}}init(t,e){return d.on("buildDataTableEV","",()=>{this.buildDataTable()}),this.kvCache=new y(t,e),this.table=this.shadow.getElementById("table"),this.tableBody=this.shadow.getElementById("table-body"),this.tableBody.addEventListener("click",this),this.tablehead=this.shadow.getElementById("table-head"),this.footer=document.getElementById("footer-component"),this.buildTableHead(),this}handleEvent(t){console.log(t.type),this[`handle${t.type}`](t)}handleclick(t){let e=t.target;console.info("row click",e),console.info("row click",e.dataset),u&&l&&e!==l&&(l.removeAttribute("contenteditable"),l.className="",l.oninput=null),u?.classList.remove("selected_row"),u=e.parentElement,u.classList.add("selected_row"),this.kvCache.CTX.FocusedKey=u.dataset.cache_key,this.footer.resetButtons(!1),l=e,l.setAttribute("contenteditable",""),l.className="editable ";let n=u.dataset.cache_key,s=l.dataset.column_id,a=parseInt(l.dataset.column_index)||0,o=this.kvCache.get(n);l.onblur=()=>{let r=l.textContent;if(l.tagName==="SELECT"){s=l.parentElement.dataset.column_id||"",a=parseInt(l.parentElement.dataset.column_index)||0;let i=l;r=i.options[i.selectedIndex].text}o[s]!==r&&(o[s]=r,a===0?n!==r&&(this.kvCache.delete(n),n=r,this.kvCache.set(n,o)):this.kvCache.set(n,o))}}scrollToBottom(){this.tableBody.rows[this.tableBody.rows.length-1].scrollIntoView({behavior:"smooth"})}buildTableHead(){let t='<tr class="headerRow">',e="";for(let n=0;n<this.kvCache.columns.length;n++)e+=`   <th id="header${n+1}" data-index=${n} value=1>${this.kvCache.columns[n].name}</th>`;this.tablehead.innerHTML+=t+e+"</tr>";for(let n=0;n<this.kvCache.columns.length;n++){let s=this.shadow.getElementById(`header${n+1}`);s.onclick=a=>{this.resetFocusedRow(),this.buildDataTable()}}}buildDataTable(){this.tableBody.innerHTML="",this.kvCache.querySet&&this.buildRows(),this.resetFocusedRow(),l?.focus()}buildRows(){let t=this.kvCache.querySet;if(t)for(let e=0;e<t.length;e++){let n=t[e],s=`<tr data-cache_key="${n[this.kvCache.columns[0].name]}">`;for(let a=0;a<this.kvCache.columns.length;a++){let o=this.kvCache.columns[a].name;switch(this.kvCache.columns[a].type){case"boolean":let r=n[o]==="true"?"checked":"";s+=`<td data-column_index=${a} 
                  data-column_id="${o}"><input type="checkbox" ${r}></td>`;break;case"number":s+=`<td data-column_index=${a} 
                  data-column_id="${o}">${parseFloat(n[o])}</td>`;break;case"object":s+=`<td data-column_index=${a} 
                  data-column_id="${o}">${this.buildSelect(this.kvCache.columns[a].defaultValue,n[o])}</td>`;break;default:s+=`<td data-column_index=${a} 
                  data-column_id="${o}">${n[o]}</td>`;break}}s+="</tr>",this.tableBody.innerHTML+=s}}buildSelect(t,e){let n=`<select>
   `;return t.forEach(s=>{e===s?n+=`<option value="${s}" selected>${s}</option>
         `:n+=`<option value="${s}">${s}</option>
      `}),n+="</select>",n}resetFocusedRow(){this.footer.resetButtons(!0),u=null}};g.register();var v={dbKey:"PWA",keyColumnName:"host",sampleRecord:{host:"Z",login:"",pw:"",remarks:""}};document.title=v.dbKey;var k={DEV:!1,LOCAL_DB:!1,LocalDbURL:"http://localhost:9099/",RemoteDbURL:"https://dt-kv-rpc.deno.dev/",RpcURL:"SSERPC/kvRegistration",PIN:"",FocusedKey:"",dbOptions:{schema:v}};document.title="DT-PWA";var w=document.getElementById("footer-component"),L=w.init(v,k);document.getElementById("pin-component").init(L.kvCache.CTX);export{E as FooterComponent,b as PinComponent,g as TableComponent,l as focusedCell,u as focusedRow,p as on};
