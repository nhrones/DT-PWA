// deno-lint-ignore-file
var T=Object.defineProperty;var h=(i,e)=>T(i,"name",{value:e,configurable:!0});var y=h((i,e,t)=>i.addEventListener(e,t),"on"),g=class extends HTMLElement{static{h(this,"PinComponent")}static register(){customElements.define("pin-component",this)}shadow;constructor(){super(),this.shadow=this.attachInternals()?.shadowRoot}init(){return new Promise((e,t)=>{let s="]]YT",n=this.shadow.getElementById("popupDialog"),o=this.shadow.getElementById("pinDialog"),a=this.shadow.getElementById("pin"),r=this.shadow.getElementById("popup_text");y(n,"click",c=>{c.preventDefault(),n.close()});let d=0,m=!1;y(n,"close",c=>{c.preventDefault(),m||o.showModal()}),y(n,"keyup",c=>{c.preventDefault(),n.close(),m||o.showModal()}),o?.addEventListener("keydown",c=>{c.key==="Escape"&&c.preventDefault()}),y(a,"keyup",c=>{c.preventDefault();let C=this.encryptText(a.value);(c.key==="Enter"||C===s)&&(d+=1,C===s?(a.value="",m=!0,o.close(),e("ok")):(o.close(),a.value="",m=!1,r&&(r.textContent=d===3?`Incorrect pin entered ${d} times!
       Please close this Page!`:`Incorrect pin entered ${d} times!`),d===3?(document.body.innerHTML=`
                     <h1>Three failed PIN attempts!</h1>
                     <h1>Please close this page!</h1>`,t("Three failed PIN attempts! You are not authorized!")):n.showModal()))}),o.showModal(),a.focus({focusVisible:!0}),document.addEventListener("keydown",function(c){c.ctrlKey&&c.key==="x"&&(c.preventDefault(),m=!0,o.close())})})}encryptText(e){let t="",s="ndhg";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e.charCodeAt(n)^s.charCodeAt(n%s.length));return t}};g.register();var E=class extends HTMLElement{static{h(this,"FooterComponent")}static register(){customElements.define("footer-component",this)}addBtn;deleteBtn;shadow;constructor(){super(),this.shadow=this.attachInternals()?.shadowRoot}init(e,t){this.addBtn=this.shadow.getElementById("addbtn"),this.addBtn.onclick=n=>{let o=Object.assign({},t.sampleRecord);for(let r in o)typeof o[r]=="object"&&(o[r]=o[r][0]);let a=t.keyColumnName;e.kvCache.set(o[a],o),e.buildDataTable(),e.scrollToBottom()},this.deleteBtn=this.shadow.getElementById("deletebtn"),this.deleteBtn.onclick=n=>{e.kvCache.delete(e.kvCache.CTX.FocusedKey),e.buildDataTable()};let s=this.shadow.getElementById("fileload");document.addEventListener("keydown",function(n){if(n.ctrlKey&&n.key==="b"){n.preventDefault();let o=JSON.stringify(Array.from(e.kvCache.dbMap.entries())),a=document.createElement("a"),r=new Blob([o],{type:"application/json"});a.href=URL.createObjectURL(r),a.download="backup.json",a.click(),URL.revokeObjectURL(a.href)}n.ctrlKey&&n.key==="r"&&(n.preventDefault(),s.click(),s.addEventListener("change",function(){let o=new FileReader;o.onload=function(){e.kvCache.restoreCache(o.result)},o.readAsText(s.files[0])}))})}resetButtons(e){e?(this.deleteBtn.setAttribute("hidden",""),this.addBtn.removeAttribute("hidden")):(this.addBtn.setAttribute("hidden",""),this.deleteBtn.removeAttribute("hidden"))}};E.register();function w(){let i=new Map;return{on(t,s,n){let o=t+"-"+s;i.has(o)?i.get(o).push(n):i.set(o,[n])},fire(t,s,n){let o=t+"-"+s,a=i.get(o);if(a)for(let r of a)r(n)}}}h(w,"newEventBus");var u=w();var f=class{static{h(this,"KvClient")}DEV=!1;nextMsgID=0;querySet=[];transactions=new Map;currentPage=1;focusedRow=null;kvCache;CTX;ServiceURL;RegistrationURL;constructor(e,t){this.CTX=t,this.DEV=t.DEV,this.ServiceURL=t.LOCAL_DB?t.LocalDbURL:t.RemoteDbURL,this.RegistrationURL=this.ServiceURL+t.RpcURL,this.kvCache=e,this.transactions=new Map}init(){let e=new EventSource(this.RegistrationURL);console.log("CONNECTING"),e.addEventListener("open",()=>{this.callProcedure(this.ServiceURL,"GET",{key:["PIN"]}).then(t=>{this.CTX.PIN=t.value,this.fetchQuerySet()})}),e.addEventListener("error",t=>{switch(e.readyState){case EventSource.OPEN:console.log("CONNECTED");break;case EventSource.CONNECTING:console.log("CONNECTING");break;case EventSource.CLOSED:console.log("DISCONNECTED");break}}),e.addEventListener("message",t=>{let s=JSON.parse(t.data),{txID:n,error:o,result:a}=s;if(n===-1&&this.handleMutation(a),!this.transactions.has(n))return;let r=this.transactions.get(n);this.transactions.delete(n),r&&r(o,a)})}handleMutation(e){console.info("Mutation event:",e)}async setKvPin(e){let t=this.kvCache.encryptText(e);await this.callProcedure(this.ServiceURL,"SET",{key:["PIN"],value:t}).then(s=>{this.DEV&&console.log(`Set PIN ${e} to: `,t)})}addNewRecord(){let e=Object.assign({},this.kvCache.schema.sampleRecord);for(let s in e)typeof e[s]=="object"&&(e[s]=e[s][0]);let t=this.kvCache.schema.keyColumnName;this.kvCache.set(e[t],e)}async fetchQuerySet(){let e=this.kvCache;await this.callProcedure(this.ServiceURL,"GET",{key:[this.kvCache.schema.dbKey]}).then(t=>{t.value?e.restoreCache(e.encryptText(t.value)):(this.addNewRecord(),u.fire("buildDataTableEV","",this.kvCache))})}get(e){for(let t=0;t<this.querySet.length;t++){let s=this.querySet[t];if(s.id===e)return s}}set(e){try{this.callProcedure(this.ServiceURL,"SET",{key:[this.kvCache.schema.dbKey],value:e}).then(t=>(this.querySet=t.querySet,this.querySet))}catch(t){return{Error:t}}}delete(e){try{this.callProcedure(this.ServiceURL,"DELETE",{key:e,value:""}).then(t=>{console.info("Delete result: ",t)})}catch(t){return{Error:t}}}callProcedure(e,t,s){let n=this.nextMsgID++;return new Promise((o,a)=>{this.transactions.set(n,(r,d)=>{if(r)return a(new Error(r));o(d)}),fetch(e,{method:"POST",mode:"cors",body:JSON.stringify({txID:n,procedure:t,params:s})})})}};var b=class{static{h(this,"KvCache")}dbKey="";schema;nextMsgID=0;querySet=[];callbacks;columns=[];kvClient;dbMap;raw=[];CTX;DEV;constructor(e,t){this.dbKey=`${e.dbKey}`,this.schema=e,this.CTX=t,this.DEV=this.CTX.DEV,this.callbacks=new Map,this.dbMap=new Map,this.columns=this.buildColumnSchema(this.schema.sampleRecord),this.kvClient=new f(this,t),this.kvClient.init()}encryptText(e){let t="",s="ndhg";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e.charCodeAt(n)^s.charCodeAt(n%s.length));return t}restoreCache(e){let t=JSON.parse(e);this.dbMap=new Map(t),this.persist(),this.hydrate()=="ok"&&u.fire("buildDataTableEV","",this)}buildColumnSchema(e){let t=[];for(let[s,n]of Object.entries(e)){let o=!1;(typeof n=="number"&&n===-1||typeof n=="string"&&n==="READONLY")&&(o=!0),t.push({name:s,type:typeof n,defaultValue:n,readOnly:o})}return t}persist(e=!0){e&&(this.dbMap=new Map([...this.dbMap.entries()].sort()));let t=JSON.stringify(Array.from(this.dbMap.entries())),s=this.encryptText(t);this.kvClient.set(s)}hydrate(){return this.raw=[...this.dbMap.values()],this.querySet=[...this.raw],u.fire("buildDataTableEV","",this),this.raw.length>2?"ok":"Not found"}resetData(){this.querySet=[...this.raw]}clean(e=null){let t=new Map;[...this.dbMap.keys()].forEach(n=>{n!==e&&t.set(n,this.dbMap.get(n))}),this.dbMap=t,this.persist(!0)}set(e,t){try{return this.dbMap.set(e,t),this.persist(!0),this.hydrate(),e}catch(s){return console.error("error setting "),"Error "+s}}get(e){try{return this.dbMap.get(e)}catch(t){return"Error "+t}}delete(e){try{let t=this.dbMap.delete(e);return t===!0&&this.persist(!0),this.hydrate(),t}catch(t){return"Error "+t}}};var l,p,v=class extends HTMLElement{static{h(this,"TableComponent")}static register(){customElements.define("table-component",this)}kvCache;footer;table;tablehead;tableBody;shadow;constructor(){super(),this.shadow=this.attachInternals()?.shadowRoot}init(e,t){return u.on("buildDataTableEV","",()=>{this.buildDataTable()}),this.kvCache=new b(e,t),this.table=this.shadow.getElementById("table"),this.tableBody=this.shadow.getElementById("table-body"),this.tableBody.addEventListener("click",this),this.tablehead=this.shadow.getElementById("table-head"),this.footer=document.getElementById("footer-component"),this.footer.init(this,e),this.buildTableHead(),this}handleEvent(e){console.log(e.type),this[`handle${e.type}`](e)}handleclick(e){let t=e.target;console.info("row click",t),console.info("row click",t.dataset),p&&l&&t!==l&&(l.removeAttribute("contenteditable"),l.className="",l.oninput=null),p?.classList.remove("selected_row"),p=t.parentElement,p.classList.add("selected_row"),this.kvCache.CTX.FocusedKey=p.dataset.cache_key,this.footer.resetButtons(!1),l=t,l.setAttribute("contenteditable",""),l.className="editable ";let s=p.dataset.cache_key,n=l.dataset.column_id,o=parseInt(l.dataset.column_index)||0,a=this.kvCache.get(s);l.onblur=()=>{let r=l.textContent;if(l.tagName==="SELECT"){n=l.parentElement.dataset.column_id||"",o=parseInt(l.parentElement.dataset.column_index)||0;let d=l;r=d.options[d.selectedIndex].text}a[n]!==r&&(a[n]=r,o===0?s!==r&&(this.kvCache.delete(s),s=r,this.kvCache.set(s,a)):this.kvCache.set(s,a))}}scrollToBottom(){this.tableBody.rows[this.tableBody.rows.length-1].scrollIntoView({behavior:"smooth"})}buildTableHead(){let e='<tr class="headerRow">',t="";for(let s=0;s<this.kvCache.columns.length;s++)t+=`   <th id="header${s+1}" data-index=${s} value=1>${this.kvCache.columns[s].name}</th>`;this.tablehead.innerHTML+=e+t+"</tr>";for(let s=0;s<this.kvCache.columns.length;s++){let n=this.shadow.getElementById(`header${s+1}`);n.onclick=o=>{this.resetFocusedRow(),this.buildDataTable()}}}buildDataTable(){this.tableBody.innerHTML="",this.kvCache.querySet&&this.buildRows(),this.resetFocusedRow(),l?.focus()}buildRows(){let e=this.kvCache.querySet;if(e)for(let t=0;t<e.length;t++){let s=e[t],n=`<tr data-cache_key="${s[this.kvCache.columns[0].name]}">`;for(let o=0;o<this.kvCache.columns.length;o++){let a=this.kvCache.columns[o].name;switch(this.kvCache.columns[o].type){case"boolean":let r=s[a]==="true"?"checked":"";n+=`<td data-column_index=${o} 
                  data-column_id="${a}"><input type="checkbox" ${r}></td>`;break;case"number":n+=`<td data-column_index=${o} 
                  data-column_id="${a}">${parseFloat(s[a])}</td>`;break;case"object":n+=`<td data-column_index=${o} 
                  data-column_id="${a}">${this.buildSelect(this.kvCache.columns[o].defaultValue,s[a])}</td>`;break;default:n+=`<td data-column_index=${o} 
                  data-column_id="${a}">${s[a]}</td>`;break}}n+="</tr>",this.tableBody.innerHTML+=n}}buildSelect(e,t){let s=`<select>
   `;return e.forEach(n=>{t===n?s+=`<option value="${n}" selected>${n}</option>
         `:s+=`<option value="${n}">${n}</option>
      `}),s+="</select>",s}resetFocusedRow(){this.footer.resetButtons(!0),p=null}};v.register();var k={dbKey:"PWA",keyColumnName:"host",sampleRecord:{host:"Z",login:"",pw:"",remarks:""}},L={DEV:!1,LOCAL_DB:!1,LocalDbURL:"http://localhost:9099/",RemoteDbURL:"https://dt-kv-rpc.deno.dev/",RpcURL:"SSERPC/kvRegistration",PIN:"",FocusedKey:"",dbOptions:{schema:k}},S=document.getElementById("pin-component");S.init().then(i=>{console.log(i),i==="ok"&&document.getElementById("table-component").init(k,L)}).catch(i=>{alert(i)});export{E as FooterComponent,g as PinComponent,v as TableComponent,l as focusedCell,p as focusedRow,y as on};
